// AI ÈÖçÁΩÆÈù¢ÊùøÁªÑ‰ª∂

import { defineComponent, ref, computed, h } from 'vue'
import {
  NCard, NSpace, NInput, NSelect, NButton, NText, NIcon, NAlert,
  NTag, NTooltip, NGrid, NGi, NStatistic
} from 'naive-ui'
import {
  Settings, Key, Cog as Cpu, CheckmarkCircle, Warning,
  Flash, Globe, Sparkles, Link, Refresh, SwapHorizontal,
  DocumentText, Download, CloudUpload
} from '@vicons/ionicons5'
import {
  AI_PROVIDERS,
  getProviderModels,
  getAvailableModels,
  type AIProviderConfig
} from './ai-config'

export interface AIConfigPanelProps {
  config: AIProviderConfig
  onConfigChange: (config: AIProviderConfig) => void
  onSave: () => void
  onImportTheme?: (theme: any) => void
  isConnected?: boolean
  lastUsed?: number
  totalGenerations?: number
}

export default defineComponent({
  name: 'AIConfigPanel',
  props: {
    config: {
      type: Object as () => AIProviderConfig,
      required: true
    },
    onConfigChange: {
      type: Function as unknown as () => (config: AIProviderConfig) => void,
      required: true
    },
    onSave: {
      type: Function as unknown as () => () => void,
      required: true
    },
    onImportTheme: {
      type: Function as unknown as () => (theme: any) => void,
      required: false
    },
    isConnected: {
      type: Boolean,
      default: false
    },
    lastUsed: Number,
    totalGenerations: {
      type: Number,
      default: 0
    }
  },
  setup(props) {
    const showApiKey = ref(false)
    const dynamicModels = ref<string[]>([])
    const isLoadingModels = ref(false)
    const useStaticModels = ref(true) // ÈªòËÆ§‰ΩøÁî®ÈùôÊÄÅÊ®°ÂûãÂàóË°®

    // JSON ÂØºÂÖ•Áõ∏ÂÖ≥Áä∂ÊÄÅ
    const jsonInput = ref('')
    const showJsonImport = ref(false)
    const importError = ref('')
    const importSuccess = ref(false)

    // ËÆ°ÁÆóAPIÂØÜÈí•ÁöÑÊòæÁ§∫Áä∂ÊÄÅ
    const maskedApiKey = computed(() => {
      if (!props.config.apiKey) return ''
      if (showApiKey.value) return props.config.apiKey
      return props.config.apiKey.slice(0, 8) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + props.config.apiKey.slice(-4)
    })

    // ËÆ°ÁÆóËøûÊé•Áä∂ÊÄÅ
    const connectionStatus = computed(() => {
      if (!props.config.apiKey) return { type: 'warning', text: 'Êú™ÈÖçÁΩÆ', color: '#faad14' }
      if (props.isConnected) return { type: 'success', text: 'Â∑≤ËøûÊé•', color: '#52c41a' }
      return { type: 'default', text: 'Êú™Áü•', color: '#d9d9d9' }
    })

    // Ê†ºÂºèÂåñÊúÄÂêé‰ΩøÁî®Êó∂Èó¥
    const formatLastUsed = (timestamp?: number) => {
      if (!timestamp) return '‰ªéÊú™‰ΩøÁî®'
      const now = Date.now()
      const diff = now - timestamp
      const minutes = Math.floor(diff / 60000)
      const hours = Math.floor(diff / 3600000)
      const days = Math.floor(diff / 86400000)

      if (days > 0) return `${days}Â§©Ââç`
      if (hours > 0) return `${hours}Â∞èÊó∂Ââç`
      if (minutes > 0) return `${minutes}ÂàÜÈíüÂâç`
      return 'ÂàöÂàö'
    }

    // Ëé∑ÂèñÂΩìÂâç‰æõÂ∫îÂïÜÁöÑÂèØÁî®Ê®°ÂûãÔºàÈùôÊÄÅÂàóË°®Ôºâ
    const staticModels = computed(() => {
      return getProviderModels(props.config.provider)
    })

    // Ëé∑ÂèñÊúÄÁªàÁöÑÊ®°ÂûãÂàóË°®ÔºàÂä®ÊÄÅÊàñÈùôÊÄÅÔºâ
    const availableModels = computed(() => {
      if (useStaticModels.value || dynamicModels.value.length === 0) {
        return staticModels.value
      }
      // Â∞ÜÂä®ÊÄÅÊ®°ÂûãËΩ¨Êç¢‰∏∫‰∏éÈùôÊÄÅÊ®°ÂûãÁõ∏ÂêåÁöÑÊ†ºÂºè
      return dynamicModels.value
        .filter(model => model && typeof model === 'string')
        .map(model => ({
          label: model,
          value: model
        }))
    })

    // ËΩ¨Êç¢‰∏∫Ëá™Âä®ÂÆåÊàêÈÄâÈ°πÊ†ºÂºè
    const modelOptions = computed(() => {
      return availableModels.value
        .filter((model: any) => model && model.label && model.value)
        .map((model: any) => ({
          label: model.label,
          value: model.value
        }))
    })

    // Âä®ÊÄÅËé∑ÂèñÊ®°ÂûãÂàóË°®
    const fetchDynamicModels = async () => {
      if (!props.config.apiKey) {
        return
      }

      isLoadingModels.value = true
      try {
        const models = await getAvailableModels(
          props.config.provider,
          props.config.apiKey,
          props.config.baseUrl
        )
        dynamicModels.value = models
        useStaticModels.value = false
      } catch (error) {
        console.error('Ëé∑ÂèñÂä®ÊÄÅÊ®°ÂûãÂàóË°®Â§±Ë¥•:', error)
        // ‰øùÊåÅ‰ΩøÁî®ÈùôÊÄÅÊ®°ÂûãÂàóË°®
      } finally {
        isLoadingModels.value = false
      }
    }

    // ÂàáÊç¢Ê®°ÂûãÂàóË°®Á±ªÂûã
    const toggleModelListType = () => {
      useStaticModels.value = !useStaticModels.value
    }

    // Ëé∑ÂèñÊ®°Âûã‰ø°ÊÅØ
    const selectedModelInfo = computed(() => {
      return availableModels.value.find((model: any) => model.value === props.config.model)
    })

    // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶‰∏∫Ëá™ÂÆö‰πâÊ®°ÂûãÔºà‰∏çÂú®È¢ÑËÆæÂàóË°®‰∏≠Ôºâ
    const isCustomModel = computed(() => {
      return props.config.model && !availableModels.value.some((model: any) => model.value === props.config.model)
    })

    // ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫È¢ùÂ§ñÈÖçÁΩÆ
    const needsBaseUrl = computed(() => {
      return props.config.provider === 'custom'
    })

    const needsOrganization = computed(() => {
      return props.config.provider === 'openai'
    })

    // Êõ¥Êñ∞ÈÖçÁΩÆ
    const updateConfig = (key: keyof AIProviderConfig, value: string) => {
      props.onConfigChange({
        ...props.config,
        [key]: value
      })
    }

    // JSON ÂØºÂÖ•Â§ÑÁêÜÂáΩÊï∞
    const handleImportJson = () => {
      importError.value = ''
      importSuccess.value = false

      if (!jsonInput.value.trim()) {
        importError.value = 'ËØ∑ËæìÂÖ• JSON ‰∏ªÈ¢òÈÖçÁΩÆ'
        return
      }

      try {
        const theme = JSON.parse(jsonInput.value.trim())

        // Âü∫Êú¨È™åËØÅÔºöÊ£ÄÊü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑ‰∏ªÈ¢òÂØπË±°
        if (typeof theme !== 'object' || theme === null) {
          throw new Error('Êó†ÊïàÁöÑ‰∏ªÈ¢òÊ†ºÂºèÔºöÂøÖÈ°ªÊòØ‰∏Ä‰∏™ÂØπË±°')
        }

        // Ë∞ÉÁî®Áà∂ÁªÑ‰ª∂ÁöÑÂØºÂÖ•ÂõûË∞É
        if (props.onImportTheme) {
          props.onImportTheme(theme)
          importSuccess.value = true
          jsonInput.value = ''

          // 3ÁßíÂêéËá™Âä®ÈöêËóèÊàêÂäüÊèêÁ§∫
          setTimeout(() => {
            importSuccess.value = false
          }, 3000)
        }
      } catch (error) {
        importError.value = `JSON Ëß£ÊûêÂ§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`
      }
    }

    // ÂàáÊç¢ JSON ÂØºÂÖ•Èù¢ÊùøÊòæÁ§∫Áä∂ÊÄÅ
    const toggleJsonImport = () => {
      showJsonImport.value = !showJsonImport.value
      if (!showJsonImport.value) {
        // ÈöêËóèÊó∂Ê∏ÖÁ©∫Áä∂ÊÄÅ
        jsonInput.value = ''
        importError.value = ''
        importSuccess.value = false
      }
    }

    // Ê∏ÖÁ©∫ JSON ËæìÂÖ•
    const clearJsonInput = () => {
      jsonInput.value = ''
      importError.value = ''
      importSuccess.value = false
    }

    return {
      showApiKey,
      maskedApiKey,
      connectionStatus,
      formatLastUsed,
      selectedModelInfo,
      availableModels,
      modelOptions,
      isCustomModel,
      needsBaseUrl,
      needsOrganization,
      updateConfig,
      dynamicModels,
      isLoadingModels,
      useStaticModels,
      fetchDynamicModels,
      toggleModelListType,
      // JSON ÂØºÂÖ•Áõ∏ÂÖ≥
      jsonInput,
      showJsonImport,
      importError,
      importSuccess,
      handleImportJson,
      toggleJsonImport,
      clearJsonInput
    }
  },
  render() {
    return (
      <NSpace vertical size="large">
        {/* Áä∂ÊÄÅÊ¶ÇËßàÂç°Áâá */}
        <NCard
          title="üîó ËøûÊé•Áä∂ÊÄÅ"
          size="small"
          style={{
            color: 'white'
          }}
          headerStyle={{ color: 'white', borderBottom: 'none' }}
          contentStyle={{ padding: '12px 20px' }}
        >
          <NGrid cols={3} xGap={16}>
            <NGi>
              <NStatistic label="ËøûÊé•Áä∂ÊÄÅ" tabularNums>
                {{
                  default: () => (
                    <NSpace align="center" size="small">
                      <NIcon
                        component={this.connectionStatus.type === 'success' ? CheckmarkCircle : Warning}
                        color={this.connectionStatus.color}
                        size={16}
                      />
                      <NText style={{ color: 'white', fontSize: '14px' }}>
                        {{
                          default: () => this.connectionStatus.text
                        }}
                      </NText>
                    </NSpace>
                  )
                }}
              </NStatistic>
            </NGi>
            <NGi>
              <NStatistic label="ÊÄªÁîüÊàêÊ¨°Êï∞" value={this.totalGenerations} tabularNums>
                {{
                  prefix: () => <NIcon component={Sparkles} style={{ color: 'white' }} />
                }}
              </NStatistic>
            </NGi>
            <NGi>
              <NStatistic label="ÊúÄÂêé‰ΩøÁî®" tabularNums>
                {{
                  default: () => (
                    <NText style={{ color: 'white', fontSize: '14px' }}>
                      {{
                        default: () => this.formatLastUsed(this.lastUsed)
                      }}
                    </NText>
                  )
                }}
              </NStatistic>
            </NGi>
          </NGrid>
        </NCard>

        {/* ÈÖçÁΩÆË°®Âçï */}
        <NCard title="‚öôÔ∏è AI ÈÖçÁΩÆ" size="small">
          <NSpace vertical size="large">
            {/* ‰æõÂ∫îÂïÜÈÄâÊã© */}
            <div>
              <NSpace align="center" size="small" style={{ marginBottom: '8px' }}>
                <NIcon component={Globe} color="#1890ff" />
                <NText strong>
                  {{
                    default: () => 'AI ‰æõÂ∫îÂïÜ'
                  }}
                </NText>
              </NSpace>
              <NSelect
                value={this.config.provider}
                options={AI_PROVIDERS}
                placeholder="ÈÄâÊã© AI ‰æõÂ∫îÂïÜ"
                onUpdateValue={(value: string) => this.updateConfig('provider', value)}
                renderLabel={(option: any) => (
                  <NSpace align="center">
                    {{
                      default: () => [
                        <NIcon component={Flash} color="#52c41a" size={14} />,
                        option.label
                      ]
                    }}
                  </NSpace>
                )}
              />
            </div>

            {/* API ÂØÜÈí• */}
            <div>
              <NSpace align="center" size="small" style={{ marginBottom: '8px' }}>
                <NIcon component={Key} color="#fa8c16" />
                <NText strong>
                  {{
                    default: () => 'API ÂØÜÈí•'
                  }}
                </NText>
                <NTooltip>
                  {{
                    trigger: () => <NIcon component={Warning} color="#faad14" size={14} />,
                    default: () => 'ËØ∑Á°Æ‰øù API ÂØÜÈí•ÂÆâÂÖ®Ôºå‰∏çË¶ÅÂú®ÂÖ¨ÂÖ±Âú∫ÊâÄÊö¥Èú≤'
                  }}
                </NTooltip>
              </NSpace>
              <NSpace>
                <NInput
                  value={this.config.apiKey}
                  type={this.showApiKey ? 'text' : 'password'}
                  placeholder="ËØ∑ËæìÂÖ• API ÂØÜÈí•"
                  onUpdateValue={(value: string) => this.updateConfig('apiKey', value)}
                  style={{ flex: 1 }}
                  showPasswordOn="click"
                />
                <NButton
                  size="small"
                  onClick={() => { this.showApiKey = !this.showApiKey }}
                >
                  {{
                    default: () => this.showApiKey ? 'ÈöêËóè' : 'ÊòæÁ§∫'
                  }}
                </NButton>
              </NSpace>
              {this.config.apiKey && (
                <NText depth={3} style={{ fontSize: '12px', marginTop: '4px' }}>
                  {{
                    default: () => `ÂΩìÂâçÂØÜÈí•: ${this.maskedApiKey}`
                  }}
                </NText>
              )}
            </div>

            {/* Ê®°ÂûãÈÄâÊã© */}
            <div>
              <NSpace align="center" size="small" style={{ marginBottom: '8px' }}>
                <NIcon component={Cpu} color="#722ed1" />
                <NText strong>
                  {{
                    default: () => 'AI Ê®°Âûã'
                  }}
                </NText>
                {this.selectedModelInfo && (
                  <NTag size="small" type="success">
                    {{
                      default: () => 'È¢ÑËÆæ'
                    }}
                  </NTag>
                )}
                {this.isCustomModel && (
                  <NTag size="small" type="info">
                    {{
                      default: () => 'Ëá™ÂÆö‰πâ'
                    }}
                  </NTag>
                )}
                {this.useStaticModels && (
                  <NTag size="small" type="default">
                    {{
                      default: () => 'ÈùôÊÄÅÂàóË°®'
                    }}
                  </NTag>
                )}
                {!this.useStaticModels && (
                  <NTag size="small" type="warning">
                    {{
                      default: () => 'Âä®ÊÄÅÂàóË°®'
                    }}
                  </NTag>
                )}
                <div style={{ marginLeft: 'auto' }}>
                  <NSpace size="small">
                    <NTooltip>
                      {{
                        trigger: () => (
                          <NButton
                            size="tiny"
                            circle
                            onClick={this.toggleModelListType}
                            disabled={this.isLoadingModels}
                          >
                            {{
                              icon: () => <NIcon component={SwapHorizontal} />
                            }}
                          </NButton>
                        ),
                        default: () => this.useStaticModels ? 'ÂàáÊç¢Âà∞Âä®ÊÄÅÊ®°ÂûãÂàóË°®' : 'ÂàáÊç¢Âà∞ÈùôÊÄÅÊ®°ÂûãÂàóË°®'
                      }}
                    </NTooltip>
                    <NTooltip>
                      {{
                        trigger: () => (
                          <NButton
                            size="tiny"
                            circle
                            onClick={this.fetchDynamicModels}
                            loading={this.isLoadingModels}
                            disabled={!this.config.apiKey}
                          >
                            {{
                              icon: () => <NIcon component={Refresh} />
                            }}
                          </NButton>
                        ),
                        default: () => 'Âà∑Êñ∞Ê®°ÂûãÂàóË°®'
                      }}
                    </NTooltip>
                  </NSpace>
                </div>
              </NSpace>
              {/* {JSON.stringify(this.modelOptions)} */}
              <NSelect
                value={this.config.model}
                options={this.modelOptions}
                placeholder="ÈÄâÊã©ÊàñËæìÂÖ• AI Ê®°ÂûãÂêçÁß∞"
                filterable
                tag
                clearable
                onUpdateValue={(value: string) => this.updateConfig('model', value)}

              />

{/* renderLabe1l={(option: any) => (
                  <NSpace align="center" justify="space-between" style={{ width: '100%' }}>
                    {{
                      default: () => [
                        {option}
                        ,
                        <NText>
                          {{
                            default: () => option.label || option.value
                          }}
                        </NText>,
                        (option.value?.includes(':free') || this.config.provider !== 'openrouter') && (
                          <NTag size="tiny" type="success">
                            {{
                              default: () => this.config.provider === 'openrouter' ? 'ÂÖçË¥π' : 'ÂèØÁî®'
                            }}
                          </NTag>
                        )
                      ]
                    }}
                  </NSpace>
                )}
                renderOp1tion={ ({ node, option }: { node: VNode, option: SelectOption }) => (
                  <NSpace align="center" justify="space-between" style={{ width: '100%' }}>
                    {{
                      default: () => [
                        <NText>
                          {{
                            default: () => option.label
                          }}
                        </NText>,
                        (option.value?.includes(':free') || this.config.provider !== 'openrouter') && (
                          <NTag size="tiny" type="success">
                            {{
                              default: () => this.config.provider === 'openrouter' ? 'ÂÖçË¥π' : 'ÂèØÁî®'
                            }}
                          </NTag>
                        )
                      ]
                    }}
                  </NSpace>
                )} */}
              <NSpace style={{ marginTop: '4px' }}>
                {this.selectedModelInfo && (
                  <NText depth={3} style={{ fontSize: '12px' }}>
                    {{
                      default: () => `È¢ÑËÆæÊ®°Âûã: ${this.selectedModelInfo?.label || ''}`
                    }}
                  </NText>
                )}
                {this.isCustomModel && (
                  <NText depth={3} style={{ fontSize: '12px', color: '#1890ff' }}>
                    {{
                      default: () => `Ëá™ÂÆö‰πâÊ®°Âûã: ${this.config.model}`
                    }}
                  </NText>
                )}
              </NSpace>
              <NSpace vertical size="small" style={{ marginTop: '4px' }}>
                <NText depth={3} style={{ fontSize: '11px', color: '#999' }}>
                  {{
                    default: () => 'üí° ÂèØ‰ª•‰ªé‰∏ãÊãâÂàóË°®ÈÄâÊã©È¢ÑËÆæÊ®°ÂûãÔºåÊàñËæìÂÖ•Ëá™ÂÆö‰πâÊ®°ÂûãÂêçÁß∞ÂêéÊåâÂõûËΩ¶ÂàõÂª∫'
                  }}
                </NText>
                {this.useStaticModels ? (
                  <NText depth={3} style={{ fontSize: '11px', color: '#666' }}>
                    {{
                      default: () => 'üìã ÂΩìÂâç‰ΩøÁî®ÈùôÊÄÅÊ®°ÂûãÂàóË°®ÔºåÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞Ê®°Âûã'
                    }}
                  </NText>
                ) : (
                  <NText depth={3} style={{ fontSize: '11px', color: '#1890ff' }}>
                    {{
                      default: () => `üîÑ Âä®ÊÄÅÊ®°ÂûãÂàóË°® (${this.dynamicModels.length} ‰∏™Ê®°Âûã)`
                    }}
                  </NText>
                )}
              </NSpace>
            </div>

            {/* Ëá™ÂÆö‰πâAPIÁ´ØÁÇπ */}
            {this.needsBaseUrl && (
              <div>
                <NSpace align="center" size="small" style={{ marginBottom: '8px' }}>
                  <NIcon component={Link} color="#13c2c2" />
                  <NText strong>
                    {{
                      default: () => 'API Á´ØÁÇπ'
                    }}
                  </NText>
                  <NTooltip>
                    {{
                      trigger: () => <NIcon component={Warning} color="#faad14" size={14} />,
                      default: () => 'ËØ∑ËæìÂÖ•ÂÖºÂÆπOpenAIÊ†ºÂºèÁöÑAPIÁ´ØÁÇπURL'
                    }}
                  </NTooltip>
                </NSpace>
                <NInput
                  value={this.config.baseUrl || ''}
                  placeholder="https://api.example.com/v1/chat/completions"
                  onUpdateValue={(value: string) => this.updateConfig('baseUrl', value)}
                />
              </div>
            )}

            {/* OpenAI ÁªÑÁªáID */}
            {this.needsOrganization && (
              <div>
                <NSpace align="center" size="small" style={{ marginBottom: '8px' }}>
                  <NIcon component={Settings} color="#722ed1" />
                  <NText strong>
                    {{
                      default: () => 'ÁªÑÁªáIDÔºàÂèØÈÄâÔºâ'
                    }}
                  </NText>
                  <NTooltip>
                    {{
                      trigger: () => <NIcon component={Warning} color="#faad14" size={14} />,
                      default: () => 'OpenAIÁªÑÁªáIDÔºåÂ¶ÇÊûúÊÇ®Â±û‰∫éÊüê‰∏™ÁªÑÁªáËØ∑Â°´ÂÜô'
                    }}
                  </NTooltip>
                </NSpace>
                <NInput
                  value={this.config.organization || ''}
                  placeholder="org-xxxxxxxxxxxxxxxxxx"
                  onUpdateValue={(value: string) => this.updateConfig('organization', value)}
                />
              </div>
            )}

            {/* ÈÖçÁΩÆÊèêÁ§∫ */}
            <NAlert type="info" showIcon={false}>
              {{
                default: () => (
                  <NSpace vertical size="small">
                    <NText strong>
                      {{
                        default: () => 'üí° ÈÖçÁΩÆÊèêÁ§∫'
                      }}
                    </NText>
                    <ul style={{ margin: 0, paddingLeft: '16px' }}>
                      {this.config.provider === 'openrouter' && (
                        <li>Êé®Ëçê‰ΩøÁî®ÂÖçË¥πÁöÑ Gemini 2.0 Flash Ê®°ÂûãÔºåÈÄüÂ∫¶Âø´‰∏îË¥®ÈáèÈ´ò</li>
                      )}
                      {this.config.provider === 'openai' && (
                        <li>ÈúÄË¶ÅÊúâÊïàÁöÑ OpenAI API ÂØÜÈí•ÔºåÊîØÊåÅ GPT-4 Á≥ªÂàóÊ®°Âûã</li>
                      )}
                      {this.config.provider === 'gemini' && (
                        <li>ÈúÄË¶Å Google AI Studio API ÂØÜÈí•ÔºåÊîØÊåÅ Gemini Á≥ªÂàóÊ®°Âûã</li>
                      )}
                      {this.config.provider === 'anthropic' && (
                        <li>ÈúÄË¶Å Anthropic API ÂØÜÈí•ÔºåÊîØÊåÅ Claude Á≥ªÂàóÊ®°Âûã</li>
                      )}
                      {this.config.provider === 'deepseek' && (
                        <li>ÈúÄË¶Å DeepSeek API ÂØÜÈí•ÔºåÊîØÊåÅ DeepSeek Á≥ªÂàóÊ®°Âûã</li>
                      )}
                      {this.config.provider === 'doubao' && (
                        <li>ÈúÄË¶ÅÂ≠óËäÇË∑≥Âä®Ë±ÜÂåÖ API ÂØÜÈí•</li>
                      )}
                      {this.config.provider === 'qwen' && (
                        <li>ÈúÄË¶ÅÈòøÈáå‰∫ëÂçÉÈóÆ API ÂØÜÈí•</li>
                      )}
                      {this.config.provider === 'custom' && (
                        <li>ËØ∑Á°Æ‰øùAPIÁ´ØÁÇπÂÖºÂÆπOpenAIÊ†ºÂºè</li>
                      )}
                      <li>API ÂØÜÈí•‰ºöÂÆâÂÖ®Â≠òÂÇ®Âú®Êú¨Âú∞ÊµèËßàÂô®‰∏≠</li>
                      <li>ÈÖçÁΩÆ‰øùÂ≠òÂêéÂç≥ÂèØÂºÄÂßãÁîüÊàê‰∏ªÈ¢ò</li>
                    </ul>
                  </NSpace>
                )
              }}
            </NAlert>

            {/* ‰øùÂ≠òÊåâÈíÆ */}
            <NButton
              type="primary"
              size="large"
              block
              onClick={this.onSave}
              disabled={!this.config.apiKey || !this.config.model}
            >
              {{
                icon: () => <NIcon component={Settings} />,
                default: () => '‰øùÂ≠òÈÖçÁΩÆ'
              }}
            </NButton>
          </NSpace>
        </NCard>

        {/* JSON ‰∏ªÈ¢òÂØºÂÖ• */}
        <NCard title="üì• ÂØºÂÖ•‰∏ªÈ¢ò" size="small">
          <NSpace vertical size="medium">
            {/* ÂØºÂÖ•ËØ¥Êòé */}
            <NSpace align="center" size="small">
              <NIcon component={DocumentText} color="#1890ff" />
              <NText>
                {{
                  default: () => 'ÂèØ‰ª•Áõ¥Êé•Á≤òË¥¥ JSON Ê†ºÂºèÁöÑ‰∏ªÈ¢òÈÖçÁΩÆËøõË°åÂø´ÈÄüÂØºÂÖ•'
                }}
              </NText>
            </NSpace>

            {/* Â±ïÂºÄ/Êî∂Ëµ∑ÊåâÈíÆ */}
            <NButton
              secondary
              block
              onClick={this.toggleJsonImport}
            >
              {{
                icon: () => <NIcon component={this.showJsonImport ? CloudUpload : Download} />,
                default: () => this.showJsonImport ? 'Êî∂Ëµ∑ÂØºÂÖ•Èù¢Êùø' : 'Â±ïÂºÄÂØºÂÖ•Èù¢Êùø'
              }}
            </NButton>

            {/* JSON ËæìÂÖ•Âå∫Âüü */}
            {this.showJsonImport && (
              <NSpace vertical size="medium">
                <NInput
                  value={this.jsonInput}
                  type="textarea"
                  placeholder="ËØ∑Á≤òË¥¥ JSON ‰∏ªÈ¢òÈÖçÁΩÆ..."
                  rows={8}
                  onUpdateValue={(value: string) => { this.jsonInput = value }}
                  style={{ fontFamily: 'Monaco, Consolas, "Courier New", monospace' }}
                />

                {/* ÈîôËØØÊèêÁ§∫ */}
                {this.importError && (
                  <NAlert type="error" showIcon>
                    {{
                      default: () => this.importError
                    }}
                  </NAlert>
                )}

                {/* ÊàêÂäüÊèêÁ§∫ */}
                {this.importSuccess && (
                  <NAlert type="success" showIcon>
                    {{
                      default: () => 'üéâ ‰∏ªÈ¢òÂØºÂÖ•ÊàêÂäüÔºÅ'
                    }}
                  </NAlert>
                )}

                {/* Êìç‰ΩúÊåâÈíÆ */}
                <NSpace>
                  <NButton
                    type="primary"
                    onClick={this.handleImportJson}
                    disabled={!this.jsonInput.trim()}
                  >
                    {{
                      icon: () => <NIcon component={CloudUpload} />,
                      default: () => 'ÂØºÂÖ•‰∏ªÈ¢ò'
                    }}
                  </NButton>
                  <NButton
                    onClick={this.clearJsonInput}
                    disabled={!this.jsonInput.trim()}
                  >
                    {{
                      default: () => 'Ê∏ÖÁ©∫'
                    }}
                  </NButton>
                </NSpace>

                {/* ‰ΩøÁî®ËØ¥Êòé */}
                <NAlert type="info" showIcon={false}>
                  {{
                    default: () => (
                      <NSpace vertical size="small">
                        <NText strong>
                          {{
                            default: () => 'üìã ‰ΩøÁî®ËØ¥Êòé'
                          }}
                        </NText>
                        <ul style={{ margin: 0, paddingLeft: '16px' }}>
                          <li>ÊîØÊåÅÊ†áÂáÜÁöÑ Naive UI ‰∏ªÈ¢òÈÖçÁΩÆÊ†ºÂºè</li>
                          <li>ÂèØ‰ª•ÂØºÂÖ•‰ªéÂÖ∂‰ªñÂú∞ÊñπÂ§çÂà∂ÁöÑ‰∏ªÈ¢ò JSON</li>
                          <li>ÂØºÂÖ•Âêé‰ºöËá™Âä®Â∫îÁî®Âà∞ÂΩìÂâç‰∏ªÈ¢òÁºñËæëÂô®</li>
                          <li>ÊîØÊåÅÂÆåÊï¥ÁöÑ‰∏ªÈ¢òË¶ÜÁõñÈÖçÁΩÆ</li>
                        </ul>
                      </NSpace>
                    )
                  }}
                </NAlert>
              </NSpace>
            )}
          </NSpace>
        </NCard>
      </NSpace>
    )
  }
})
